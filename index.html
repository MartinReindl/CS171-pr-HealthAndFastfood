<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Fast Food and Health in the US</title>

    <!-- ADD Libraries-->
    <script src="libs/d3/d3.min.js" charset="utf-8"></script>
    <script src="libs/topojson/topojson.v1.min.js"></script>
    <script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
    <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>
    <script src="libs/queue-master/queue.min.js"></script>
	<script src="http://d3js.org/colorbrewer.v1.min.js"></script>
    <script src="libs/d3-tip/index.js"></script>



    <!--Stylesheets-->
    <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/font.css">
    <link rel="stylesheet" type="text/css" href="css/myStyle.css">

    <!-- our vis classes-->
    <script src = "js/statevis.js"></script>
    <script src = "js/restaurantvis.js"></script>
    <script src = "js/healthvis.js"></script>
    <script src = "js/legendvis.js"></script>

</head>
<body>

    <h1><center>Fast Food and Health in the United States</center></h1>
    <div class="row">
        <div class="col-md-3">
            <div class="col-md-2"></div>
            <div class="col-md-10">
                <h2>Change Map</h2>
				Select fast food chains to display on map:<br>
                <input type="checkbox" name="fast_food_scatter" class="event"
                id="Starbucks_scatter" value="Starbucks" checked/>
                <label for="Starbucks">Starbucks</label>
                <input type="checkbox" name="fast_food_scatter" class="event"
                id="McDonalds_scatter" value="McDonalds" checked/>
                <label for="McDonalds">McDonald's</label>
                <input type="checkbox" name="fast_food_scatter" class="event"
                id="BurgerKing_scatter" value="BurgerKing" checked/>
                <label for="BurgerKing">Burger King</label>
                <input type="checkbox" name="fast_food_scatter" class="event"
                id="DairyQueen_scatter" value="DQ" checked/>
                <label for="DairyQueen">Dairy Queen</label>
                <br>
                Select health measure to Visualize with Heat Map:
				<br>
				<input type="radio" name="health_measure" value="Obesity" checked> Obesity<br>
                <input type="radio" name="health_measure" 
                       value="Cardiovascular Disease"> Cardiovascular Disease<br>
                <input type="radio" name="health_measure" value="Diabetes"> Diabetes<br>
                <input type="radio" name="health_measure" value="Mental Health"> Mental Health<br>
				<h2>Change Bar Graphs </h2>
                Select fast food chains to display in bar graph:<br>
                <input type="checkbox" name="fast_food" class="event"
                id="Starbucks" value="S_perCapita" checked/>
                <label for="Starbucks">Starbucks</label>
                <input type="checkbox" name="fast_food" class="event"
                id="McDonalds" value="MD_perCapita" checked/>
                <label for="McDonalds">McDonald's</label>
                <input type="checkbox" name="fast_food" class="event"
                id="BurgerKing" value="BK_perCapita" />
                <label for="BurgerKing">Burger King</label>
                <input type="checkbox" name="fast_food" class="event"
                id="DairyQueen" value="DQ_perCapita" checked/>
                <label for="DairyQueen">Dairy Queen</label>
                <br>
                Select health measures to display in bar graph:<br>
                <input type="checkbox" name="health_measure" class="event"
                id="Obesity" value="Obesity" checked/>
                <label for="Obesity">Obesity</label>
                <input type="checkbox" name="health_measure" class="event"
                id="mental_health" value="Mental Health" checked/>
                <label for="mental_health">Poor Mental Health</label>
                <input type="checkbox" name="health_measure" class="event"
                id="Diabetes" value="Diabetes" />
                <label for="Diabetes">Diabetes</label>
                <input type="checkbox" name="health_measure" class="event"
                id="cardiovascular_disease" value="Cardiovascular Disease" checked/>
                <label for="cardiovascular_disease">Cardiovascular Disease</label>
                <br>
            </div>
        </div>
        <div class="col-md-7" id="stateVis">
        </div>
        <div class="col-md-2">
            <form action="">Select Map Items:<br>

            </form>
        </div>
    </div>
    <div class="row">
        <div class='col-sm-5' id='restaurantVis'>
            <center><h2><b>Health Measures</b></h2></center>
        </div>
        <div class='col-sm-2' id='legendVis'></div>
        <div class='col-sm-5' id='healthVis'>
            <center><h2><b>Fast Food Restaurants</b></h2></center>
        </div>
    </div>




    <script>
        $(function(){  // this function is executed when the page is loaded

            //==========================================
            //--- HERE IS WHERE ALL THE MAGIC STARTS --
            //==========================================


            // variables keeping global knowledge of the data
            var restaurantData = [];
            var mapData = {};
            var stateData = [];
			var health_measure_selection = "Obesity";
            var selection1; 
            var selection2; 
            var selection_switch = true; 
			var restaurant_filter = ["Starbucks", "BurgerKing", "McDonalds", "DQ"]
			var filtered_restaurantData = restaurantData;


            //Create an eventHandler
            var MyEventHandler = new Object();

            // call this function after Data is loaded, reformatted and bound to the variables
            var initVis = function(){

                //Instantiate all Vis Objects here
                var state_vis = new StateVis(d3.select("#stateVis"), restaurantData, mapData, stateData, MyEventHandler);
                var restaurant_vis = new RestaurantVis(d3.select("#restaurantVis"), stateData, MyEventHandler);
                var health_vis = new HealthVis(d3.select("#healthVis"), stateData, MyEventHandler);
                var legend_vis = new LegendVis(d3.select("#legendVis"), stateData, MyEventHandler);

				// helper function to see if an array contains a value
				function contains(array, value){
					for(var i in array){
						if(array[i] == value){
							return i;
						}
					}
					return -1;
				}

				// helper function to change restaurant filters when checkbox is checked
				function update_restaurant_filters(){
					d3.selectAll("input").each(function(d){
						if(d3.select(this).attr("type") == "checkbox" &&
						   d3.select(this).attr("name") == "fast_food_scatter" &&
						   d3.select(this).node().checked){
							var restaurant = d3.select(this).attr("value");
							if(contains(restaurant_filter, restaurant) >= 0){
								// do nothing
							}
							else{
								restaurant_filter.push(restaurant)
							}
						}
						else{
							if(d3.select(this).attr("name") == "fast_food_scatter"){
								var restaurant = d3.select(this).attr("value");
								var index = contains(restaurant_filter, restaurant)
								if(index >= 0){
									restaurant_filter.splice(index, 1)
								}
							}
						}
					})
				}
	
				function update_health_encoding(){
					d3.selectAll("input").each(function(d){
						if(d3.select(this).attr("type") == "radio" &&
							d3.select(this).node().checked){
							health_measure_selection = d3.select(this).attr("value");
						}
					})
				}

				function filter_restaurant_data(){
					function filter_by_restaurant(restaurant){
						if (contains(restaurant_filter, restaurant["Restaurant"]) >= 0){
							return true;
						}
						else {
							return false;
						}
					}
					filtered_restaurantData = restaurantData.filter(filter_by_restaurant)
				}

				// bind actions to filter buttons
				d3.selectAll("input").on("change", function(){
					update_restaurant_filters();
					update_health_encoding();
					filter_restaurant_data();
					state_vis.updateVis(filtered_restaurantData, health_measure_selection);
				})

                $(MyEventHandler).bind("selectionChanged", function(event, _selection){

                    // check if a new selection has been made
                    if (_selection !== "checkbox"){
                         // update selection
                        if (selection_switch === true){
                            // save new selection
                            selection1 = _selection;
                            // flip switch
                            selection_switch = false; 

                        } else {
                            // save new selection
                            selection2 = _selection
                            // flip switch 
                            selection_switch = true; 
                        }
                    }

                    // create supporting visualizations
                    restaurant_vis.onSelectionChange(selection1, selection2);
                    health_vis.onSelectionChange(selection1, selection2);
                    legend_vis.onSelectionChange(selection1, selection2);
                });



            }

            // call this function after both files are loaded -- error should be "null" if no error
            var dataLoaded = function (error, _restaurantData, _mapData, _stateData) {

                if (!error) {

                    // save loaded data
                    restaurantData = _restaurantData;
                    mapData = _mapData; 
                    stateData = _stateData; 

                    // set initial selections
                    selection1 = stateData[22];
                    selection2 = stateData[44];

                    // parse floats and ints from csv string values
                    stateData.forEach(function (d){
                        for (var k in d){
                            
                            if (k === "restaurants" || k === "BurgerKing" || k === "McDonalds"
                                || k === "DairyQueen" || k === "Starbucks" || k === "id"){
                                d[k] = parseInt(d[k]);
                            }
                            else if (k !== "name" && k !== "code"){
                                d[k] = parseFloat(d[k]);
                            }
                        }
                    })

                    console.log(restaurantData);
                    console.log(mapData);
                    console.log(stateData);

                    initVis();
                }
            }

            var startHere = function(){
                // load data
				queue()
                    .defer(d3.csv, 'data/restaurant_locations.csv') 
                    .defer(d3.json, 'data/us.json')
                    .defer(d3.csv, 'data/states.csv')
                    .await(dataLoaded);
            }
     
            startHere();

            // add event listeners for checkboxes
            d3.selectAll("input").on("click", function (){
                $(MyEventHandler).trigger("selectionChanged", "checkbox");
            });

        })
    </script>
</body>
</html>
